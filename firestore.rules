rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Is de gebruiker ingelogd?
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Is de gebruiker de eigenaar van het document?
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper: Is de gebruiker een admin?
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Gebruikers collectie
    match /users/{userId} {
      // Lezen mag alleen als het je eigen profiel is (PRIVACY: e-mailadressen afschermen)
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      
      // Belangrijk: Gebruiker mag NIET zijn eigen rol of credits aanpassen!
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (
        isAdmin() || 
        (request.auth.uid == userId && (
          // 1. Rol mag niet wijzigen
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) &&
          
          // 2. Credits mogen NIET wijzigen (tenzij omlaag via backend)
          (
            (request.resource.data.get('usage', {}).get('weatherCredits', 0) <= resource.data.get('usage', {}).get('weatherCredits', 0)) &&
            (request.resource.data.get('usage', {}).get('baroCredits', 0) <= resource.data.get('usage', {}).get('baroCredits', 0))
          ) &&
          
          // 3. Andere gevoelige velden (waaronder game-statistieken)
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isBanned', 'subscription', 'gameStats']) &&

          // 4. Username validation if changed
          (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['username']) || 
            (request.resource.data.username.size() >= 5 && 
             request.resource.data.username.size() <= 25 && 
             request.resource.data.username.matches('^[a-zA-Z0-9 ]+$'))
          )
        ))
      );
      
      // Audit logs binnen een gebruiker
      match /audit_logs/{logId} {
        allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow delete: if isOwner(userId) || isAdmin(); // Sta verwijderen toe voor opschoning
        allow update: if false;
      }
      
      // High/Low Results (Geschiedenis) - Alleen lezen, schrijven via server
      match /highlow_results/{resultId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow write: if false; // Via server
      }
      
      // High/Low Last Game (Details laatste spel) - Alleen lezen, schrijven via server
      match /highlow/{docId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow write: if false; // Via server
      }
    }

    // --- Usernames Collectie (Voor uniekheidscheck zonder privacy-lek) ---
    match /usernames/{username} {
      // Iedereen mag checken of een naam bestaat
      allow read: if isSignedIn();
      // Je mag een naam claimen als je je eigen UID erin zet
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      // Je mag je naam vrijgeven (verwijderen) als hij van jou is
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // --- Versla Baro Gamificatie --- 
 
    // Game Rounds: Iedereen die ingelogd is kan rondes bekijken 
    match /game_rounds/{roundId} { 
      allow read: if isSignedIn(); 
      allow write: if isAdmin(); // Alleen admin/backend kan rondes maken/sluiten 

      // Game Bets: Gebruikers kunnen hun eigen inzetten beheren binnen een ronde
      match /bets/{userId} {
        // Iedereen mag de bets zien (nodig voor statistieken en leaderboard)
        allow read: if isSignedIn();
        // Je mag een bet aanmaken en bijwerken als het voor jezelf is (pad Ã©n data moeten matchen)
        // EN de ronde moet nog 'open' zijn.
        allow create, update: if isSignedIn() && 
                               request.auth.uid == userId && 
                               request.resource.data.userId == request.auth.uid &&
                               get(/databases/$(database)/documents/game_rounds/$(roundId)).data.status == 'open';
        // Deletes blokkeren we
        allow delete: if false;
      }
    }

    // Systeem configuratie (Banner & App blokkade)
    match /system/config {
      allow read: if true; // Iedereen moet kunnen zien of de app geblokkeerd is
      allow write: if isAdmin(); // Alleen de admin (jij dus) kan dit aanpassen
    }

    // Admin audit logs
    match /admin_audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false; // Admin logs kunnen niet worden gewist
    }

    // Purchases (Omzet)
    match /purchases/{purchaseId} {
      allow read: if isAdmin();
      allow write: if false; // Alleen via backend/Stripe, nooit via de app
    }
    
    // Leaderboards (Openbaar voor ingelogde gebruikers, alleen lezen)
    match /leaderboards/{boardId}/entries/{entryId} {
      allow read: if isSignedIn();
      allow write: if false; // Alleen via backend (Game Master)
    }

    // High/Low Leaderboards (Lezen: iedereen, Schrijven: NIEMAND, alleen server)
    match /highlow_leaderboards/{periodId}/entries/{userId} {
      allow read: if isSignedIn();
      allow write: if false; // Alleen via submit-highlow-score function
    }

    // Guess Who History
    match /users/{userId}/guesswho_results/{gameId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if false; // Alleen via server function
    }

    // Guess Who Leaderboards (Lezen: iedereen, Schrijven: NIEMAND, alleen server)
    match /guesswho_leaderboards/{periodId}/entries/{userId} {
      allow read: if isSignedIn();
      allow write: if false; // Alleen via submit-guesswho-score function
    }

    // Specifieke regel voor collectionGroup queries op 'bets'
    match /{path=**}/bets/{betId} {
      allow read: if isSignedIn() && (request.auth.uid == betId || resource.data.userId == request.auth.uid);
    }

    // Fallback: ontzeg alle andere toegang
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
